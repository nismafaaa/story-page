const CACHE_NAME="story-app-cache-v3",STATIC_ASSETS=["/","/index.html","/manifest.json"];self.addEventListener("install",(e=>{console.log("ðŸŸ¢ [ServiceWorker] Installing..."),e.waitUntil((async()=>{self.skipWaiting();const e=await caches.open(CACHE_NAME),t=[];for(const n of STATIC_ASSETS)try{const o=await fetch(n,{cache:"no-cache"});if(!o.ok)throw new Error(`Fetch failed (${o.status})`);await e.put(n,o.clone()),t.push({asset:n,status:"cached"})}catch(e){t.push({asset:n,status:"failed",reason:e.message||String(e)})}console.log("ðŸŸ¢ [ServiceWorker] Cache install result:",t)})())})),self.addEventListener("activate",(e=>{console.log("ðŸŸ£ [ServiceWorker] Activated"),e.waitUntil((async()=>{const e=await caches.keys();await Promise.all(e.map((e=>e!==CACHE_NAME?caches.delete(e):Promise.resolve()))),self.clients.claim()})())})),self.addEventListener("fetch",(e=>{"GET"===e.request.method&&e.respondWith(caches.match(e.request).then((t=>t||fetch(e.request).then((t=>caches.open(CACHE_NAME).then((n=>{try{n.put(e.request,t.clone())}catch(e){}return t})))).catch((()=>{if("navigate"===e.request.mode)return caches.match("/index.html")})))))})),self.addEventListener("push",(e=>{try{if("granted"!==Notification.permission)return void console.warn("ðŸ”• [ServiceWorker] Push event received but notification permission not granted.");const t=e.data?.json()||{},n=t.title||"Cerita Baru!",o={body:t.body||"Ada cerita baru yang menunggumu!",icon:"/icons/icon-192x192.png",badge:"/icons/icon-192x192.png",data:t,actions:[{action:"open",title:"Buka Cerita"}]};e.waitUntil(self.registration.showNotification(n,o))}catch(e){console.warn("ðŸ”¶ [ServiceWorker] push handler error:",e)}})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=(e.notification.data||{}).url||"/";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{if(e.length>0){const n=e[0];return n.focus(),n.url!==t&&n.navigate?n.navigate(t):void 0}return clients.openWindow(t)})))})),self.addEventListener("message",(e=>{try{if("push-mock"===e.data?.type){if("granted"!==Notification.permission)return console.warn("ðŸ”• [ServiceWorker] Mock push requested but notification permission not granted."),void(e.source&&e.source.postMessage&&e.source.postMessage({type:"push-mock-result",ok:!1,reason:"no-permission"}));const{title:t,body:n}=e.data.data;self.registration.showNotification(t,{body:n,icon:"/icons/icon-192x192.png",badge:"/icons/icon-192x192.png"}),console.log("ðŸ”” [ServiceWorker] Mock push received")}}catch(e){console.warn("ðŸ”¶ [ServiceWorker] message handler error:",e)}}));